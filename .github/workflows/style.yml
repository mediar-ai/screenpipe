name: Code Quality & Optimization

on: [push]

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: "-A unexpected_cfgs -A unused_variables -A unused_imports -A dead_code"

jobs:
  optimize:
    name: Dependency & Performance Checks
    runs-on: ubuntu-latest # Vi kör bara på Ubuntu för att spara tid och undvika Mac-krascher
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libssl-dev pkg-config

      - name: Check for unused dependencies
        uses: bnjbvr/cargo-machete@main
        continue-on-error: true

      - name: Run checks (Permissive Mode)
        run: |
          rustup install nightly
          cargo install cargo-udeps cargo-bloat cargo-audit cargo-deny --locked || true
          cargo +nightly udeps || true
          cargo bloat --release || true
          cargo audit || true
          cargo deny check duplicates || true
        continue-on-error: true