name: E2E Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  windows-e2e-test:
    name: Windows E2E Tests
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4
    - name: Setup Bun
      uses: oven-sh/setup-bun@v2
      with:
        bun-version: 1.1.43
    - name: Setup Node
      uses: actions/setup-node@v4
      with:
        node-version: 22
    - name: Install Chocolatey
      run: |
        [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
        Set-ExecutionPolicy Bypass -Scope Process -Force; iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
    - name: Install dependencies
      shell: pwsh
      run: |
        choco install ffmpeg openssl
        echo "C:\ProgramData\chocolatey\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
    - name: Install Scream on Windows
      shell: powershell
      run: |
        Invoke-WebRequest https://github.com/duncanthrax/scream/releases/download/4.0/Scream4.0.zip -OutFile Scream4.0.zip
        Expand-Archive -Path Scream4.0.zip -DestinationPath Scream
        openssl req -batch -verbose -x509 -newkey rsa -keyout ScreamCertificate.pvk -out ScreamCertificate.cer -nodes -extensions v3_req
        openssl pkcs12 -export -nodes -in ScreamCertificate.cer -inkey ScreamCertificate.pvk -out ScreamCertificate.pfx -passout pass:
    - name: Set up MSVC
      uses: ilammy/msvc-dev-cmd@v1
    - name: Sign and Install Scream Driver on Windows
      shell: powershell
      run: |
        signtool sign /v /fd SHA256 /f ScreamCertificate.pfx Scream\Install\driver\x64\Scream.cat
        Import-Certificate -FilePath ScreamCertificate.cer -CertStoreLocation Cert:\LocalMachine\root
        Import-Certificate -FilePath ScreamCertificate.cer -CertStoreLocation Cert:\LocalMachine\TrustedPublisher
        Scream\Install\helpers\devcon-x64.exe install Scream\Install\driver\x64\Scream.inf *Scream
      timeout-minutes: 5
    - name: Start Windows Audio Service
      shell: powershell
      run: net start audiosrv
    - name: Install Rust
      run: |
        Invoke-WebRequest https://static.rust-lang.org/rustup/dist/x86_64-pc-windows-gnu/rustup-init.exe -OutFile rustup-init.exe
        .\rustup-init.exe -y
    - name: Set up Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable
        override: true
        cache: true
        target: x86_64-pc-windows-msvc
    - name: Install vcpkg
      uses: lukka/run-vcpkg@v11
      with:
        vcpkgGitCommitId: "7adc2e4d49e8d0efc07a369079faa6bc3dbb90f3"
    - name: Install 7zip
      shell: powershell
      run: |
        $7zipUrl = "https://7-zip.org/a/7z2301-x64.exe"
        Invoke-WebRequest -Uri $7zipUrl -OutFile 7z-installer.exe
        Start-Process -FilePath .\7z-installer.exe -Args "/S" -Wait
        echo "C:\Program Files\7-Zip" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
    - name: Install LLVM and Clang
      uses: KyleMayes/install-llvm-action@v2
      with:
        version: "10.0"
        directory: "C:\\Program Files\\LLVM"
    - name: Install pip
      uses: actions/setup-python@v5
      with:
        python-version: "3.13"
    - name: Copy library for MKL/vcredist
      shell: pwsh
      run: |
        $mkl_dir = "screenpipe-app-tauri/src-tauri/mkl"
        New-Item -ItemType Directory -Force -Path $mkl_dir
        python -m pip install intel-openmp --target temp_omp
        Get-ChildItem -Path temp_omp -Recurse -Filter "*.dll" | Copy-Item -Destination $mkl_dir -Force
        $vcredist_dir = "screenpipe-app-tauri/src-tauri/vcredist"
        New-Item -ItemType Directory -Force -Path $vcredist_dir
        Copy-Item C:\Windows\System32\vcruntime140.dll -Destination $vcredist_dir -Force
    - name: Build CLI
      shell: pwsh
      run: cargo build --release -p screenpipe-server --target x86_64-pc-windows-msvc
    - name: Install frontend dependencies
      working-directory: ./screenpipe-app-tauri
      run: bun install
    - name: Build App
      uses: tauri-apps/tauri-action@v0.5.17
      env:
        CI: true
        # VIKTIGT: Här slår vi ihop ignore-flaggorna med Windows-specifika flaggor
        RUSTFLAGS: "-A unexpected_cfgs -A unused_variables -A unused_imports -A dead_code -C target-feature=+crt-static -C link-arg=/LTCG"
      with:
        args: "--target x86_64-pc-windows-msvc --no-bundle"
        projectPath: "./screenpipe-app-tauri"
        tauriScript: bunx tauri -v
    - name: Run E2E Tests
      shell: pwsh
      working-directory: ./screenpipe-app-tauri
      run: bun run test:e2e

  linux-e2e-test:
    name: Linux E2E Tests
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Setup Bun
      uses: oven-sh/setup-bun@v2
      with:
        bun-version: 1.1.43
    - name: Install Linux dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg tesseract-ocr cmake clang libavformat-dev libavfilter-dev libavdevice-dev libssl-dev libsoup-3.0-0 libtesseract-dev libxdo-dev libsdl2-dev libxtst-dev libx11-dev libgl1-mesa-dev libasound2-dev libpulse-dev curl xvfb x11-xserver-utils pkg-config libayatana-appindicator3-dev libwebkit2gtk-4.1-dev webkit2gtk-driver
    - name: Set up Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable
    - name: Build CLI
      run: cargo build --release -p screenpipe-server --target x86_64-unknown-linux-gnu
    - name: Install frontend dependencies
      working-directory: ./screenpipe-app-tauri
      run: bun install
    - name: Build App
      uses: tauri-apps/tauri-action@v0.5.17
      env:
        CI: true
        RUSTFLAGS: "-A unexpected_cfgs -A unused_variables -A unused_imports -A dead_code"
      with:
        args: "--target x86_64-unknown-linux-gnu --no-bundle"
        projectPath: "./screenpipe-app-tauri"
        tauriScript: bunx tauri -v
    - name: Run E2E Tests
      shell: bash
      working-directory: ./screenpipe-app-tauri
      run: |
        export DISPLAY=:99
        Xvfb :99 -screen 0 1024x768x24 &
        bun run test:e2e