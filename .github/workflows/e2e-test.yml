name: E2E Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  windows-e2e-test:
    name: Windows E2E Tests
    runs-on: windows-2019
    steps:
    - uses: actions/checkout@v4

    - name: Setup Bun & Node
      uses: oven-sh/setup-bun@v2

    - uses: actions/setup-node@v4
      with:
        node-version: 22

    # FIX: Vcpkg is required for static linking on Windows in your release-app workflow
    - name: Install vcpkg
      uses: lukka/run-vcpkg@v11
      with:
        vcpkgGitCommitId: "7adc2e4d49e8d0efc07a369079faa6bc3dbb90f3"

    - name: Install LLVM and Clang
      uses: KyleMayes/install-llvm-action@v2
      with:
        version: "10.0"

    - name: Install OpenSSL
      shell: powershell
      run: |
        choco install openssl
        openssl version

    - name: Setup MSVC Dev Cmd
      uses: ilammy/msvc-dev-cmd@v1
        
    - name: Force Rust Warning Overrides
      shell: bash
      run: |
        mkdir -p .cargo
        echo '[build]' >> .cargo/config.toml
        echo 'rustflags = ["-A", "warnings", "-A", "unexpected_cfgs", "-C", "target-feature=+crt-static", "-C", "link-arg=/LTCG"]' >> .cargo/config.toml

    # FIX: Create the log directory manually so the upload step doesn't fail
    - name: Pre-create Log File
      shell: bash
      run: |
        mkdir -p screenpipe-app-tauri
        echo "Build initiated" > ./screenpipe-app-tauri/e2e_output.log

    - name: Build
      uses: tauri-apps/tauri-action@v0.5.17
      env:
        CI: true
        VCPKG_STATIC_LINKAGE: "true" # Matches release-app.yml
      with:
        args: "--target x86_64-pc-windows-msvc --no-bundle"
        projectPath: "./screenpipe-app-tauri"
        tauriScript: bunx tauri -v
        
    - name: Run E2E Tests
      shell: pwsh
      working-directory: ./screenpipe-app-tauri
      run: |
        bun run test:e2e >> e2e_output.log 2>&1
      continue-on-error: true
      
    - name: Upload Logs
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: windows-e2e-logs
        path: |
          ./screenpipe-app-tauri/e2e_output.log