name: E2E Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  # Global fail-safe
  RUSTFLAGS: "-A unexpected_cfgs -A unused_variables -A unused_imports -A dead_code"

jobs:
  windows-e2e-test:
    name: Windows E2E Tests
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4

    - name: Setup Bun
      uses: oven-sh/setup-bun@v2
      with:
        bun-version: 1.1.43

    - name: Setup Node
      uses: actions/setup-node@v4
      with:
        node-version: 22

    - name: Install Chocolatey
      run: |
        [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
        Set-ExecutionPolicy Bypass -Scope Process -Force; [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072; iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))

    - name: Install dependencies
      shell: pwsh
      run: |
        choco install ffmpeg openssl
        echo "C:\ProgramData\chocolatey\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

    - name: Install Scream on Windows
      shell: powershell
      run: |
        Invoke-WebRequest https://github.com/duncanthrax/scream/releases/download/4.0/Scream4.0.zip -OutFile Scream4.0.zip
        Expand-Archive -Path Scream4.0.zip -DestinationPath Scream
        openssl req -batch -verbose -x509 -newkey rsa -keyout ScreamCertificate.pvk -out ScreamCertificate.cer -nodes -extensions v3_req
        openssl pkcs12 -export -nodes -in ScreamCertificate.cer -inkey ScreamCertificate.pvk -out ScreamCertificate.pfx -passout pass:

    - name: Set up MSVC
      uses: ilammy/msvc-dev-cmd@v1

    - name: Sign and Install Scream Driver on Windows
      shell: powershell
      run: |
        signtool sign /v /fd SHA256 /f ScreamCertificate.pfx Scream\Install\driver\x64\Scream.cat
        Import-Certificate -FilePath ScreamCertificate.cer -CertStoreLocation Cert:\LocalMachine\root
        Import-Certificate -FilePath ScreamCertificate.cer -CertStoreLocation Cert:\LocalMachine\TrustedPublisher
        Scream\Install\helpers\devcon-x64.exe install Scream\Install\driver\x64\Scream.inf *Scream
      timeout-minutes: 5

    - name: Start Windows Audio Service
      shell: powershell
      run: net start audiosrv

    - name: Install Rust
      run: |
        Invoke-WebRequest https://static.rust-lang.org/rustup/dist/x86_64-pc-windows-gnu/rustup-init.exe -OutFile rustup-init.exe
        .\rustup-init.exe -y

    - name: Set up Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable
        override: true
        cache: true
        target: x86_64-pc-windows-msvc

    - name: Build CLI on Windows
      shell: pwsh
      env:
        RUSTFLAGS: "-A warnings"
      run: cargo build --release -p screenpipe-server --target x86_64-pc-windows-msvc

    - name: Install frontend dependencies
      working-directory: ./screenpipe-app-tauri
      run: bun install

    - name: Run pre_build.js
      run: bun ./scripts/pre_build.js
      working-directory: ./screenpipe-app-tauri

    - name: Build
      uses: tauri-apps/tauri-action@v0.5.17
      env:
        CI: true
        # HÄR ÄR FIXEN: Vi lägger till -A warnings direkt i stegets egna RUSTFLAGS
        RUSTFLAGS: "-A warnings -C target-feature=+crt-static -C link-arg=/LTCG"
        CARGO_PROFILE_RELEASE_LTO: thin
        CARGO_PROFILE_RELEASE_OPT_LEVEL: 2
        CARGO_PROFILE_RELEASE_CODEGEN_UNITS: 16
        CARGO_INCREMENTAL: true
        VCPKG_STATIC_LINKAGE: "true"
        KNF_STATIC_CRT: "1"
      with:
        args: "--target x86_64-pc-windows-msvc --no-bundle"
        projectPath: "./screenpipe-app-tauri"
        tauriScript: bunx tauri -v

    - name: Run E2E Tests
      shell: pwsh
      working-directory: ./screenpipe-app-tauri
      run: |
        bun run test:e2e > e2e_output.log 2>&1
      continue-on-error: true

    - name: Upload E2E Test Artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: windows-e2e-test-artifacts
        path: |
          ./screenpipe-app-tauri/e2e/videos/*
          ./screenpipe-app-tauri/e2e_output.log

  linux-e2e-test:
    name: Linux E2E Tests
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Setup Bun
      uses: oven-sh/setup-bun@v2
      with:
        bun-version: 1.1.43

    - name: Setup Node
      uses: actions/setup-node@v4
      with:
        node-version: 22

    - name: Install Linux dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg tesseract-ocr cmake clang libavformat-dev libavfilter-dev libavdevice-dev libssl-dev libsoup-3.0-0 libtesseract-dev libxdo-dev libsdl2-dev libxtst-dev libx11-dev libgl1-mesa-dev libasound2-dev libpulse-dev curl xvfb pkg-config libayatana-appindicator3-dev libwebkit2gtk-4.1-dev webkit2gtk-driver librsvg2-dev patchelf

    - name: Set up Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable
        override: true
        cache: true
        target: x86_64-unknown-linux-gnu

    - name: Build CLI on Linux
      env:
        RUSTFLAGS: "-A warnings"
      run: cargo build --release -p screenpipe-server --target x86_64-unknown-linux-gnu

    - name: Install frontend dependencies
      working-directory: ./screenpipe-app-tauri
      run: bun install

    - name: Run pre_build.js
      run: bun ./scripts/pre_build.js
      working-directory: ./screenpipe-app-tauri

    - name: Build
      uses: tauri-apps/tauri-action@v0.5.17
      env:
        CI: true
        # FIX FÖR LINUX: Tvinga ignore även här
        RUSTFLAGS: "-A warnings"
        CARGO_PROFILE_RELEASE_LTO: false
        CARGO_PROFILE_RELEASE_OPT_LEVEL: 3
      with:
        args: "--target x86_64-unknown-linux-gnu --no-bundle"
        projectPath: "./screenpipe-app-tauri"
        tauriScript: bunx tauri -v

    - name: Run E2E Tests
      shell: bash
      working-directory: ./screenpipe-app-tauri
      run: |
        export DISPLAY=:99
        Xvfb :99 -screen 0 1024x768x24 &
        bun run test:e2e > e2e_output.log 2>&1
      continue-on-error: true

    - name: Upload E2E Test Artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: linux-e2e-test-artifacts
        path: |
          ./screenpipe-app-tauri/e2e/videos/*
          ./screenpipe-app-tauri/e2e_output.log