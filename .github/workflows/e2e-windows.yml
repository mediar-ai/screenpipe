name: Windows E2E Tests

on:
  # Run after app release builds complete
  workflow_run:
    workflows: ["Release App"]
    types: [completed]
    branches: [main]
  # Manual trigger
  workflow_dispatch:
    inputs:
      runner:
        description: "Runner label (self-hosted runner name)"
        required: false
        default: "windows-desktop-test"
      skip_build:
        description: "Skip build (self-hosted only, app already installed)"
        type: boolean
        default: false

concurrency:
  group: e2e-windows-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # ── Self-hosted: bb + API tests on real desktop ──────────────────────────────
  e2e-self-hosted:
    name: Windows E2E (self-hosted)
    runs-on: [self-hosted, "${{ inputs.runner || 'windows-desktop-test' }}"]
    timeout-minutes: 30
    if: >
      github.event_name == 'workflow_dispatch' ||
      github.event.workflow_run.conclusion == 'success'

    steps:
      - uses: actions/checkout@v4

      - name: System info
        shell: pwsh
        run: |
          echo "hostname: $env:COMPUTERNAME"
          echo "os: $((Get-CimInstance Win32_OperatingSystem).Caption)"
          echo "cpu: $((Get-CimInstance Win32_Processor).Name)"
          echo "memory: $([math]::Round((Get-CimInstance Win32_ComputerSystem).TotalPhysicalMemory / 1GB))GB"

      - name: Install/update BigBrother CLI
        shell: pwsh
        run: |
          $bbDir = "$env:USERPROFILE\Documents\bigbrother"
          if (Test-Path $bbDir) {
            cd $bbDir
            git pull
          } else {
            cd "$env:USERPROFILE\Documents"
            git clone https://github.com/louis030195/bigbrother.git
          }
          cd $bbDir
          cargo build --release -p bb
          $bbBin = "$bbDir\target\release"
          echo $bbBin | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          & "$bbBin\bb.exe" --version

      - name: Wait for screenpipe to be running
        shell: pwsh
        run: |
          $proc = Get-Process -Name "screenpipe*" -ErrorAction SilentlyContinue
          if (-not $proc) {
            echo "screenpipe not running, attempting to start..."
            $appPath = Get-ChildItem "$env:LOCALAPPDATA\screenpipe" -Filter "screenpipe*.exe" -Recurse | Select-Object -First 1
            if ($appPath) {
              Start-Process $appPath.FullName
              Start-Sleep -Seconds 15
            } else {
              echo "warning: could not find screenpipe executable"
            }
          }
          for ($i = 1; $i -le 30; $i++) {
            try {
              $response = Invoke-RestMethod -Uri "http://localhost:3030/health" -TimeoutSec 5
              echo "health API ready"
              break
            } catch {
              echo "waiting for health API... ($i/30)"
              Start-Sleep -Seconds 2
            }
          }

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Run bb + API E2E tests
        id: e2e
        shell: pwsh
        env:
          ARTIFACTS_DIR: ${{ runner.temp }}\e2e-artifacts
        run: |
          bun .github/scripts/e2e/run-all.ts 2>&1 | Tee-Object -FilePath "${{ runner.temp }}\e2e-full.log"

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-windows-self-hosted-${{ github.run_id }}
          path: |
            ${{ runner.temp }}\e2e-artifacts\
            ${{ runner.temp }}\e2e-full.log
          retention-days: 14

  # ── GitHub-hosted: build app + tauri-driver WebdriverIO tests ────────────────
  # Full DOM-level UI testing via tauri-driver (WebView2 WebDriver)
  e2e-webdriver:
    name: Windows E2E (WebDriver)
    runs-on: windows-latest
    timeout-minutes: 60
    if: >
      github.event_name == 'workflow_dispatch' ||
      github.event.workflow_run.conclusion == 'success'

    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install Chocolatey
        run: |
          [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
          Set-ExecutionPolicy Bypass -Scope Process -Force; [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072; iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))

      - name: Install dependencies
        shell: pwsh
        run: |
          choco install ffmpeg openssl -y
          echo "C:\ProgramData\chocolatey\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Install Scream virtual audio
        shell: powershell
        run: |
          Invoke-WebRequest https://github.com/duncanthrax/scream/releases/download/4.0/Scream4.0.zip -OutFile Scream4.0.zip
          Expand-Archive -Path Scream4.0.zip -DestinationPath Scream
          openssl req -batch -verbose -x509 -newkey rsa -keyout ScreamCertificate.pvk -out ScreamCertificate.cer -nodes -extensions v3_req
          openssl pkcs12 -export -nodes -in ScreamCertificate.cer -inkey ScreamCertificate.pvk -out ScreamCertificate.pfx -passout pass:

      - name: Set up MSVC
        uses: ilammy/msvc-dev-cmd@v1

      - name: Sign and Install Scream Driver
        shell: powershell
        run: |
          signtool sign /v /fd SHA256 /f ScreamCertificate.pfx Scream\Install\driver\x64\Scream.cat
          Import-Certificate -FilePath ScreamCertificate.cer -CertStoreLocation Cert:\LocalMachine\root
          Import-Certificate -FilePath ScreamCertificate.cer -CertStoreLocation Cert:\LocalMachine\TrustedPublisher
          Scream\Install\helpers\devcon-x64.exe install Scream\Install\driver\x64\Scream.inf *Scream
        timeout-minutes: 5

      - name: Start Windows Audio Service
        shell: powershell
        run: |
          $service = Get-Service -Name audiosrv
          if ($service.Status -ne 'Running') {
            net start audiosrv
          }

      - name: Install Rust
        run: |
          Invoke-WebRequest https://static.rust-lang.org/rustup/dist/x86_64-pc-windows-gnu/rustup-init.exe -OutFile rustup-init.exe
          .\rustup-init.exe -y

      - name: Set up Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          override: true
          cache: true
          target: x86_64-pc-windows-msvc
          rustflags: ""

      - name: Install vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: "7adc2e4d49e8d0efc07a369079faa6bc3dbb90f3"

      - name: Install 7zip
        shell: powershell
        run: |
          $7zipUrl = "https://7-zip.org/a/7z2301-x64.exe"
          Invoke-WebRequest -Uri $7zipUrl -OutFile 7z-installer.exe
          Start-Process -FilePath .\7z-installer.exe -Args "/S" -Wait
          Remove-Item 7z-installer.exe
          echo "C:\Program Files\7-Zip" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Install LLVM and Clang
        uses: KyleMayes/install-llvm-action@v2
        with:
          version: "10.0"
          directory: "C:\\Program Files\\LLVM"

      - name: Install pip
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Copy library for MKL
        shell: pwsh
        run: |
          $mkl_dir = "apps/screenpipe-app-tauri/src-tauri/mkl"
          New-Item -ItemType Directory -Force -Path $mkl_dir | Out-Null
          python -m pip install --upgrade pip
          $temp_dir = "temp_omp"
          New-Item -ItemType Directory -Force -Path $temp_dir | Out-Null
          python -m pip install intel-openmp --target $temp_dir
          Get-ChildItem -Path $temp_dir -Recurse -Filter "*.dll" | ForEach-Object {
            Copy-Item $_.FullName -Destination $mkl_dir -Force
          }
          $dll_count = (Get-ChildItem -Path $mkl_dir -Filter "*.dll").Count
          if ($dll_count -eq 0) { throw "No DLLs found!" }
          Remove-Item -Path $temp_dir -Recurse -Force

      - name: Copy library for vcredist
        shell: powershell
        run: |
          $vcredist_dir = "apps/screenpipe-app-tauri/src-tauri/vcredist"
          New-Item -ItemType Directory -Force -Path $vcredist_dir | Out-Null
          Copy-Item C:\Windows\System32\vcruntime140.dll -Destination $vcredist_dir -Force

      - name: Build CLI
        shell: pwsh
        env:
          CARGO_PROFILE_RELEASE_STRIP: symbols
          CARGO_PROFILE_RELEASE_PANIC: abort
          CARGO_PROFILE_RELEASE_INCREMENTAL: false
        run: cargo build --release -p screenpipe-server --target x86_64-pc-windows-msvc

      - name: Install frontend dependencies
        working-directory: ./apps/screenpipe-app-tauri
        run: bun install

      - name: Run pre_build.js
        working-directory: ./apps/screenpipe-app-tauri
        run: bun ./scripts/pre_build.js

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0.5.17
        env:
          CI: true
          CARGO_PROFILE_RELEASE_LTO: thin
          CARGO_PROFILE_RELEASE_OPT_LEVEL: 2
          CARGO_PROFILE_RELEASE_CODEGEN_UNITS: 16
          CARGO_INCREMENTAL: true
          CARGO_PROFILE_RELEASE_STRIP: symbols
          CARGO_PROFILE_RELEASE_PANIC: abort
          CARGO_PROFILE_RELEASE_INCREMENTAL: false
          RUSTFLAGS: "-C target-feature=+crt-static -C link-arg=/LTCG"
          VCPKG_STATIC_LINKAGE: "true"
          KNF_STATIC_CRT: "1"
        with:
          args: "--target x86_64-pc-windows-msvc --no-bundle"
          projectPath: "./apps/screenpipe-app-tauri"
          tauriScript: bunx tauri -v

      - name: Install tauri-driver
        shell: pwsh
        run: |
          if (-not (Test-Path "$env:USERPROFILE\.cargo\bin\tauri-driver.exe")) {
            cargo install tauri-driver
          }

      - name: Remove previous Edge WebDriver
        shell: pwsh
        run: |
          $folderPath = "$($env:SystemDrive)\SeleniumWebDrivers\EdgeDriver"
          if (Test-Path $folderPath) {
            Remove-Item -Path $folderPath -Recurse -Force
          }

      - name: Download matching Edge WebDriver
        continue-on-error: true
        shell: pwsh
        run: |
          cd ./apps/screenpipe-app-tauri
          $edgeVersion = (bun tauri info | Select-String 'WebView2').ToString().Split(':')[1].Trim()
          Write-Output "Detected Edge version: $edgeVersion"
          cd ..
          $driverUrl = "https://msedgedriver.azureedge.net/$edgeVersion/edgedriver_win64.zip"
          Invoke-WebRequest -Uri $driverUrl -OutFile edgedriver.zip
          Expand-Archive edgedriver.zip -DestinationPath edgedriver
          echo (Join-Path $PWD 'edgedriver') | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Run WebDriver E2E Tests
        continue-on-error: true
        shell: pwsh
        working-directory: ./apps/screenpipe-app-tauri
        run: |
          bun run test:e2e 2>&1 | Tee-Object -FilePath e2e_output.log

      - name: Upload E2E Test Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-windows-webdriver-${{ github.run_id }}
          path: |
            ./apps/screenpipe-app-tauri/e2e/videos/*
            ./apps/screenpipe-app-tauri/e2e_output.log

      - name: Upload Screenpipe data
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-windows-screenpipe-data-${{ github.run_id }}
          include-hidden-files: true
          path: |
            ~/.screenpipe/*
