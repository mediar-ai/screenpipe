name: Rust Benchmark

on: [push]

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: "-A unexpected_cfgs -A warnings"

jobs:
  run_benchmarks:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            name: apple
            cmd: brew install ffmpeg && cargo bench --bench ocr_benchmark -- --output-format bencher
          - os: ubuntu-latest
            name: tesseract
            cmd: sudo apt-get update && sudo apt-get install -y pkg-config libasound2-dev libleptonica-dev libtesseract-dev tesseract-ocr-eng libx11-dev libxi-dev libxext-dev libxtst-dev libxrandr-dev libxinerama-dev libxcursor-dev libxdo-dev libxcb1-dev libxcb-render0-dev libxcb-shape0-dev libxcb-xfixes0-dev && cargo bench --bench ocr_benchmark -- --output-format bencher
          - os: windows-latest
            name: windows
            cmd: cargo bench --bench ocr_benchmark -- --output-format bencher
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Run benchmark
        shell: bash
        run: ${{ matrix.cmd }} | tee ocr_${{ matrix.name }}.txt
      - uses: actions/upload-artifact@v4
        with:
          name: ocr-data-${{ matrix.name }}
          path: ocr_${{ matrix.name }}.txt

  analyze:
    needs: run_benchmarks
    runs-on: ubuntu-latest
    if: always()
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - name: Download all benchmark data
        uses: actions/download-artifact@v4
        with:
          path: ./cache/raw
          merge-multiple: true
      - name: Consolidate
        run: |
          mkdir -p ./cache/ocr
          cat ./cache/raw/ocr_*.txt > ./cache/ocr/ocr_output.txt || echo "No data" > ./cache/ocr/ocr_output.txt
      - name: Analyze OCR benchmarks
        uses: benchmark-action/github-action-benchmark@v1
        with:
          name: OCR Benchmarks
          tool: "cargo"
          output-file-path: ./cache/ocr/ocr_output.txt
          github-token: ${{ secrets.GITHUB_TOKEN }}
          auto-push: true