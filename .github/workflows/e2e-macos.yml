name: macOS E2E Tests

on:
  pull_request:
    branches: [main]
    paths:
      - '.github/scripts/e2e/**'
      - '.github/workflows/e2e-macos.yml'
  workflow_run:
    workflows: ["Release App"]
    types: [completed]
    branches: [main]
  workflow_dispatch:
    branches: [main]

concurrency:
  group: e2e-macos-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ── Tier 1: GitHub hosted runner ──────────────────────────────────────────
  # Build CLI from source, start server, test API + health
  # No screen recording or mic — tests what we can without permissions
  e2e-hosted:
    name: macOS E2E (hosted)
    runs-on: macos-14  # M1, Sonoma
    timeout-minutes: 45
    if: >
      github.event_name == 'pull_request' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')

    steps:
      - uses: actions/checkout@v4

      - name: System info
        run: |
          echo "hostname: $(hostname)"
          echo "os:       $(sw_vers -productVersion)"
          echo "chip:     $(sysctl -n machdep.cpu.brand_string)"
          echo "memory:   $(sysctl -n hw.memsize | awk '{printf "%.0fGB", $1/1073741824}')"

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Install system deps
        run: brew install ffmpeg pkg-config

      - name: Build CLI
        run: |
          cargo build --release -p screenpipe-server --features metal
          echo "CLI built successfully"
          ls -la target/release/screenpipe

      - name: Start screenpipe server
        run: |
          # Start without screen/audio recording — just the server + API
          # --disable-vision and --disable-audio to skip permission-gated features
          ./target/release/screenpipe \
            --disable-vision \
            --disable-audio \
            --port 3030 &
          SERVER_PID=$!
          echo "SERVER_PID=$SERVER_PID" >> $GITHUB_ENV
          echo "server started (PID: $SERVER_PID)"

          # Wait for health API
          for i in $(seq 1 30); do
            if curl -sf http://localhost:3030/health > /dev/null 2>&1; then
              echo "✓ health API responding"
              curl -sf http://localhost:3030/health | python3 -m json.tool
              break
            fi
            echo "waiting for health API... ($i/30)"
            sleep 2
          done

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Run API tests
        env:
          ARTIFACTS_DIR: ${{ runner.temp }}/e2e-artifacts
        run: |
          mkdir -p "$ARTIFACTS_DIR"
          bun .github/scripts/e2e/run-all.ts --suite api 2>&1 | tee "${{ runner.temp }}/e2e-full.log"

      - name: Stop server
        if: always()
        run: kill $SERVER_PID 2>/dev/null || true

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-hosted-${{ github.run_id }}
          path: |
            ${{ runner.temp }}/e2e-artifacts/
            ${{ runner.temp }}/e2e-full.log
          retention-days: 14

  # ── Tier 2: Self-hosted runner (Mac Mini M4 Pro) ───────────────────────────
  # Full E2E: build Tauri app, install, launch, test UI via bb + API
  e2e-self-hosted:
    name: macOS E2E (self-hosted)
    runs-on: [self-hosted, macos-test]
    timeout-minutes: 60
    # SECURITY: Only run on main branch — self-hosted runner has credentials.
    # Never run on PRs (fork code could be malicious).
    if: >
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/feat/e2e-macos-ci') &&
      (github.event_name == 'workflow_dispatch' ||
       (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success'))

    steps:
      - uses: actions/checkout@v4

      - name: Setup PATH
        run: |
          # Persist PATH for all subsequent steps
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
          echo "/opt/homebrew/bin" >> $GITHUB_PATH
          echo "/usr/local/bin" >> $GITHUB_PATH

      - name: System info
        run: |
          echo "hostname: $(hostname)"
          echo "os:       $(sw_vers -productVersion)"
          echo "chip:     $(sysctl -n machdep.cpu.brand_string)"
          echo "memory:   $(sysctl -n hw.memsize | awk '{printf "%.0fGB", $1/1073741824}')"
          system_profiler SPDisplaysDataType 2>/dev/null | grep -A5 "Resolution" || true

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Install system deps
        run: |
          brew install ffmpeg pkg-config cmake wget 2>/dev/null || true

          # Ensure Xcode (not just CLT) is selected — needed for cidre framework
          if [ -d "/Applications/Xcode.app" ]; then
            sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
            xcodebuild -version
          else
            echo "ERROR: Xcode.app not found in /Applications!"
            echo "Install Xcode from the App Store, then run:"
            echo "  sudo xcode-select -s /Applications/Xcode.app/Contents/Developer"
            echo "  sudo xcodebuild -license accept"
            echo "  sudo xcodebuild -runFirstLaunch"
            exit 1
          fi

      - name: Install/update BigBrother CLI
        run: |
          if [ -d "$HOME/bigbrother" ]; then
            cd "$HOME/bigbrother" && git pull
          else
            git clone https://github.com/louis030195/bigbrother.git "$HOME/bigbrother"
          fi
          cd "$HOME/bigbrother"
          cargo build --release -p bb
          # Symlink so TCC permission (granted to target/release/bb) is preserved
          sudo ln -sf "$HOME/bigbrother/target/release/bb" /usr/local/bin/bb
          /usr/local/bin/bb --version

      - name: Install frontend deps
        run: |
          cd apps/screenpipe-app-tauri
          bun install

      - name: Build and install Tauri app
        env:
          SCREENPIPE_APP_DEV: "true"
        run: |
          cd apps/screenpipe-app-tauri

          # Build the app bundle
          bunx tauri build 2>&1 | tail -50

          # Find the built .app (use absolute path)
          APP_PATH=$(find "$(pwd)/src-tauri/target/release/bundle/macos" -name "*.app" -maxdepth 1 | head -1)
          if [ -z "$APP_PATH" ]; then
            echo "ERROR: no .app bundle found"
            find src-tauri/target -name "*.app" 2>/dev/null || true
            exit 1
          fi
          echo "✓ Built: $APP_PATH"

          # Kill any existing screenpipe
          pkill -f "screenpipe" 2>/dev/null || true
          sleep 2

          # Install to /Applications
          APP_BASENAME=$(basename "$APP_PATH")
          echo "Installing $APP_BASENAME to /Applications/"
          sudo rm -rf "/Applications/$APP_BASENAME"
          sudo cp -R "$APP_PATH" "/Applications/$APP_BASENAME"
          echo "✓ Installed: /Applications/$APP_BASENAME"

          echo "APP_PATH=$APP_PATH" >> $GITHUB_ENV
          echo "INSTALLED_APP=/Applications/$APP_BASENAME" >> $GITHUB_ENV

      - name: Grant app permissions
        continue-on-error: true
        run: |
          # The app needs Accessibility + Screen Recording + Microphone
          # Grant via AppleScript automation of System Settings (we have accessibility for sshd)
          APP_BINARY="$INSTALLED_APP/Contents/MacOS/screenpipe-app"

          if [ ! -f "$APP_BINARY" ]; then
            # Try alternate binary name
            APP_BINARY=$(find "$INSTALLED_APP/Contents/MacOS/" -type f | head -1)
          fi
          echo "App binary: $APP_BINARY"

          # Check if already has accessibility
          EXISTING=$(sudo sqlite3 "/Library/Application Support/com.apple.TCC/TCC.db" \
            "SELECT COUNT(*) FROM access WHERE service='kTCCServiceAccessibility' AND client='$APP_BINARY';" 2>/dev/null || echo "0")

          if [ "$EXISTING" = "0" ]; then
            echo "Granting permissions via AppleScript..."

            # Grant Accessibility
            open "x-apple.systempreferences:com.apple.preference.security?Privacy_Accessibility"
            sleep 3
            osascript -e "
              tell application \"System Events\"
                tell process \"System Settings\"
                  set theGroup to group 1 of scroll area 1 of group 1 of group 2 of splitter group 1 of group 1 of window 1
                  click button 1 of theGroup
                  delay 2
                  try
                    set theSheet to sheet 1 of window 1
                    set value of text field \"Password\" of theSheet to \"$RUNNER_PASSWORD\"
                    delay 0.3
                    click button \"Modify Settings\" of theSheet
                    delay 2
                  end try
                  key code 5 using {command down, shift down}
                  delay 2
                  keystroke \"$APP_BINARY\"
                  delay 0.5
                  key code 36
                  delay 2
                  key code 36
                  delay 1
                end tell
              end tell
            " 2>&1 || echo "⚠ Failed to grant accessibility"

            # Grant Screen Recording
            killall "System Settings" 2>/dev/null; sleep 1
            open "x-apple.systempreferences:com.apple.preference.security?Privacy_ScreenCapture"
            sleep 3
            osascript -e "
              tell application \"System Events\"
                tell process \"System Settings\"
                  set theGroup to group 1 of scroll area 1 of group 1 of group 2 of splitter group 1 of group 1 of window 1
                  click button 1 of theGroup
                  delay 2
                  try
                    set theSheet to sheet 1 of window 1
                    set value of text field \"Password\" of theSheet to \"$RUNNER_PASSWORD\"
                    delay 0.3
                    click button \"Modify Settings\" of theSheet
                    delay 2
                  end try
                  key code 5 using {command down, shift down}
                  delay 2
                  keystroke \"$APP_BINARY\"
                  delay 0.5
                  key code 36
                  delay 2
                  key code 36
                  delay 1
                end tell
              end tell
            " 2>&1 || echo "⚠ Failed to grant screen capture"

            killall "System Settings" 2>/dev/null
          else
            echo "✓ App already has permissions"
          fi
        env:
          RUNNER_PASSWORD: ${{ secrets.RUNNER_PASSWORD }}

      - name: Pre-seed app config
        run: |
          # Skip onboarding and set defaults so the app starts the server immediately
          mkdir -p ~/.screenpipe
          if [ ! -f ~/.screenpipe/store.bin ]; then
            cat > ~/.screenpipe/store.bin << 'STORE'
          {
            "onboarding": {
              "completedAt": "2026-01-01T00:00:00+00:00",
              "currentStep": null,
              "isCompleted": true
            },
            "settings": {}
          }
          STORE
            echo "✓ Pre-seeded store.bin with onboarding completed"
          else
            echo "✓ store.bin already exists"
            python3 -c "import json; d=json.load(open('$HOME/.screenpipe/store.bin')); print('onboarding:', d.get('onboarding',{}).get('isCompleted','?'))"
          fi

      - name: Launch app and wait for health
        run: |
          # Launch the installed app
          open "$INSTALLED_APP"
          echo "Launched $INSTALLED_APP, waiting for health API..."

          # Wait for health API
          for i in $(seq 1 60); do
            if curl -sf http://localhost:3030/health > /dev/null 2>&1; then
              echo "✓ health API ready (attempt $i)"
              curl -sf http://localhost:3030/health | python3 -m json.tool
              break
            fi
            echo "waiting... ($i/60)"
            sleep 3
          done

          if ! curl -sf http://localhost:3030/health > /dev/null 2>&1; then
            echo "ERROR: health API never responded"
            # Dump logs
            find ~/Library/Logs -name "*screenpipe*" -mmin -5 -exec cat {} \; 2>/dev/null | tail -50
            exit 1
          fi

          # Determine the app name for bb (as shown in accessibility)
          # The process name from the binary
          APP_PROC=$(basename "$INSTALLED_APP" .app)
          echo "SCREENPIPE_APP_NAME=$APP_PROC" >> $GITHUB_ENV

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Run API tests
        env:
          ARTIFACTS_DIR: ${{ runner.temp }}/e2e-artifacts
          SCREENPIPE_APP_NAME: ${{ env.SCREENPIPE_APP_NAME }}
        run: |
          mkdir -p "$ARTIFACTS_DIR"
          bun .github/scripts/e2e/run-all.ts --suite api 2>&1 | tee "${{ runner.temp }}/e2e-full.log"

      - name: Run launch tests
        if: success()
        env:
          ARTIFACTS_DIR: ${{ runner.temp }}/e2e-artifacts
          SCREENPIPE_APP_NAME: ${{ env.SCREENPIPE_APP_NAME }}
        run: |
          bun .github/scripts/e2e/run-all.ts --suite launch 2>&1 | tee -a "${{ runner.temp }}/e2e-full.log"

      - name: Run window tests
        if: success()
        continue-on-error: true
        env:
          ARTIFACTS_DIR: ${{ runner.temp }}/e2e-artifacts
          SCREENPIPE_APP_NAME: ${{ env.SCREENPIPE_APP_NAME }}
        run: |
          bun .github/scripts/e2e/run-all.ts --suite window 2>&1 | tee -a "${{ runner.temp }}/e2e-full.log"

      - name: Run settings tests
        if: success()
        continue-on-error: true
        env:
          ARTIFACTS_DIR: ${{ runner.temp }}/e2e-artifacts
          SCREENPIPE_APP_NAME: ${{ env.SCREENPIPE_APP_NAME }}
        run: |
          bun .github/scripts/e2e/run-all.ts --suite settings 2>&1 | tee -a "${{ runner.temp }}/e2e-full.log"

      - name: Run recording tests
        if: success()
        continue-on-error: true
        env:
          ARTIFACTS_DIR: ${{ runner.temp }}/e2e-artifacts
          SCREENPIPE_APP_NAME: ${{ env.SCREENPIPE_APP_NAME }}
        run: |
          bun .github/scripts/e2e/run-all.ts --suite recording 2>&1 | tee -a "${{ runner.temp }}/e2e-full.log"

      - name: Run permissions tests
        if: success()
        continue-on-error: true
        env:
          ARTIFACTS_DIR: ${{ runner.temp }}/e2e-artifacts
          SCREENPIPE_APP_NAME: ${{ env.SCREENPIPE_APP_NAME }}
        run: |
          bun .github/scripts/e2e/run-all.ts --suite permissions 2>&1 | tee -a "${{ runner.temp }}/e2e-full.log"

      - name: Cleanup
        if: always()
        run: |
          # Kill the app
          pkill -f "screenpipe-app" 2>/dev/null || true
          pkill -f "screenpipe" 2>/dev/null || true
          killall "System Settings" 2>/dev/null || true
          sleep 2

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-self-hosted-${{ github.run_id }}
          path: |
            ${{ runner.temp }}/e2e-artifacts/
            ${{ runner.temp }}/e2e-full.log
          retention-days: 14
